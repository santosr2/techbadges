[env]
# Ensure consistent environment across all developers
_.path = ["./node_modules/.bin"]

[tools]
# Runtime
bun = "1.3"

# Release tools
"pipx:bump-my-version" = "latest"  # Version bumping
"cargo:git-cliff" = "latest"       # Changelog generation

[tasks.install]
description = "Install dependencies"
run = "bun install"

[tasks.dev]
description = "Start development server"
run = "bun run dev"

[tasks.build]
description = "Build icons bundle"
run = "bun run build"

[tasks."build:optimize"]
description = "Optimize SVGs and build"
run = "bun run build:optimize"

[tasks.lint]
description = "Run Biome linter"
run = "bun run lint"

[tasks."lint:fix"]
description = "Fix linting issues"
run = "bun run lint:fix"

[tasks.format]
description = "Format code with Biome"
run = "bun run format"

[tasks.typecheck]
description = "Run TypeScript type checking"
run = "bun run typecheck"

[tasks.test]
description = "Run tests"
run = "bun test"

[tasks."test:watch"]
description = "Run tests in watch mode"
run = "bun test --watch"

[tasks.validate]
description = "Validate icons"
run = "bun run validate:icons"

[tasks."size-report"]
description = "Generate icon size report"
run = "bun run size-report"

[tasks.deploy]
description = "Deploy to Cloudflare Workers"
run = "bun run deploy"

[tasks.check]
description = "Run all checks (lint, typecheck, test)"
run = ["bun run lint", "bun run typecheck", "bun test"]

[tasks."bump:patch"]
description = "Bump patch version (1.0.0 â†’ 1.0.1)"
run = "bump-my-version bump patch"

[tasks."bump:minor"]
description = "Bump minor version (1.0.0 â†’ 1.1.0)"
run = "bump-my-version bump minor"

[tasks."bump:major"]
description = "Bump major version (1.0.0 â†’ 2.0.0)"
run = "bump-my-version bump major"

[tasks."bump:show"]
description = "Show current version"
run = "bump-my-version show current_version"

[tasks."changelog:generate"]
description = "Generate full changelog"
run = "git cliff --output CHANGELOG.md"

[tasks."changelog:update"]
description = "Update changelog with unreleased commits"
run = "git cliff --unreleased --prepend CHANGELOG.md"

[tasks."changelog:preview"]
description = "Preview unreleased changelog"
run = "git cliff --unreleased"

[tasks."release:prepare"]
description = "Prepare release (bump version and update changelog)"
run = [
  "echo 'ðŸš€ Preparing release...'",
  "bump-my-version bump ${BUMP_TYPE:-patch}",
  "git cliff --tag v$(cat package.json | jq -r '.version') --output CHANGELOG.md",
  "git add CHANGELOG.md",
  "git commit --amend --no-edit",
  "echo 'âœ… Release prepared! Push with: git push origin main --tags'"
]

[tasks."release:notes"]
description = "Generate release notes for current version"
run = '''
  VERSION=$(cat package.json | jq -r '.version')
  PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
  if [ -z "$PREV_TAG" ]; then
    git cliff --unreleased --strip all
  else
    git cliff ${PREV_TAG}..v${VERSION} --strip all
  fi
'''
