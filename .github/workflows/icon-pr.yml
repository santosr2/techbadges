name: Icon PR Validation

on:
  pull_request:
    paths:
      - 'icons/**/*.svg'

jobs:
  validate-icons:
    name: Validate Icon Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          install: true

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get changed SVG files
        id: changed
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} -- 'icons/*.svg' | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed SVG files: $CHANGED_FILES"

      - name: Validate icons
        run: mise run validate

      - name: Check icon sizes
        run: |
          echo "## Changed Icons Size Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|" >> $GITHUB_STEP_SUMMARY

          for file in ${{ steps.changed.outputs.files }}; do
            if [ -f "$file" ]; then
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
              SIZE_KB=$(echo "scale=1; $SIZE / 1024" | bc)

              if [ "$SIZE" -gt 51200 ]; then
                echo "| $file | ${SIZE_KB}KB | :warning: Over 50KB |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $file | ${SIZE_KB}KB | :white_check_mark: OK |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Check themed pairs
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Themed Pairs Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          MISSING_PAIRS=""
          for file in ${{ steps.changed.outputs.files }}; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .svg)

              # Check if this is a themed icon
              if [[ "$basename" == *"-Dark" ]]; then
                light_variant="${file/-Dark.svg/-Light.svg}"
                if [ ! -f "$light_variant" ]; then
                  MISSING_PAIRS="$MISSING_PAIRS\n- $basename is missing Light variant"
                fi
              elif [[ "$basename" == *"-Light" ]]; then
                dark_variant="${file/-Light.svg/-Dark.svg}"
                if [ ! -f "$dark_variant" ]; then
                  MISSING_PAIRS="$MISSING_PAIRS\n- $basename is missing Dark variant"
                fi
              fi
            fi
          done

          if [ -n "$MISSING_PAIRS" ]; then
            echo ":warning: **Missing themed pairs:**" >> $GITHUB_STEP_SUMMARY
            echo -e "$MISSING_PAIRS" >> $GITHUB_STEP_SUMMARY
          else
            echo ":white_check_mark: All themed pairs are complete" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run SVGO optimization check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## SVGO Optimization Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          mise run build:optimize -- --dry-run 2>&1 | head -30 >> $GITHUB_STEP_SUMMARY || true

  build-check:
    name: Build with New Icons
    runs-on: ubuntu-latest
    needs: validate-icons
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          install: true

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: mise run build

      - name: Run tests
        run: mise run test
